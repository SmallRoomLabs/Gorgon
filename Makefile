TARGET  = gorgon

PASMO	= pasmo6
PASMOFLAGS = --tapbas --listing gorgon.lst
ZX7 = zx7/zx7

EMU	= fuse
#EMUFLAGS= --late-timings --graphics-filter advmame2x --no-confirm-action
EMUFLAGS= --late-timings --graphics-filter 2x --no-confirm-action

INCLUDES = \
	macros.asm \
	key.asm \
	ground.asm \
	score.asm \
	ship.asm \
	ytable.asm \
	fatfont.inc \
	shipdata.inc \
	grounddata.inc \
	groundmapdata.inc \
	colors.inc \
	mapXscaler.inc \
	mapYscaler.inc \
	interrupt.asm 

.PHONY : all run assets clean fullclean

all : clean $(ZX7) $(TARGET).tap run

$(TARGET).tap : gorgon.asm $(INCLUDES)
	@echo "[assembling to .tap"]
	@$(PASMO) $(PASMOFLAGS) $< $@

run :
	@$(EMU) $(EMUFLAGS) $(TARGET).tap 2> /dev/null

shipdata.inc : assets/shipR.txt assets/shipL.txt
	@echo "[spriting ships]"
	@echo ";" > $@
	@echo "; Autogenerated by spriter.sh" >> $@
	@echo ";" >> $@
	@spriteMaker/spriter.sh assets/shipR.txt shipR reverse >> $@
	@echo "       DS 32 ; Filler" >> $@
	@spriteMaker/spriter.sh assets/shipL.txt shipL reverse > /tmp/tmp.tmp
	@cat /tmp/tmp.tmp | grep LUT >> $@
	@cat /tmp/tmp.tmp | grep -v LUT >> $@
	@echo "" >> $@
	@echo " IF shipL0 - shipR0 != 256" >> $@
	@echo "   .ERROR ShipL0 and shipR0 must be $100 bytes apart" >> $@
	@echo " ENDIF" >> $@

colors.inc :
	@echo "[creating colors]"
	@./createColorNames.sh > $@

grounddata.inc :
	@echo "[creating ground]"
#	@createGround/process.sh assets/groundTest.txt > $@
	@createGround/process.sh assets/grounddata.txt > $@

groundmapdata.inc :
	@echo "[creating groundmap]"
	@createGround/makemap.sh assets/groundmapdata.txt GroundMap > $@

fatfont.inc : assets/fatfont.txt
	@echo "[creating fatfont]"
	@echo ";" > $@
	@echo "; Autogenerated to createFont.sh" >> $@
	@echo ";" >> $@
	@echo "FatFont:" >> $@
	@./createFont.sh assets/fatfont.txt 32 >>$@

mapXscaler.inc :
	@echo "[creating mapXScaler]"
	@echo ";" > $@
	@echo "; Autogenerated to createScalerTable.sh" >> $@
	@echo ";" >> $@
	@echo "LookupMapXscaler" >> $@
	@./createScalerTable.sh "DB " 0 127 6640 8 >>$@

mapYscaler.inc :
	@echo "[creating mapYScaler]"
	@echo ";" > $@
	@echo "; Autogenerated to createScalerTable.sh" >> $@
	@echo ";" >> $@
	@echo "LookupMapYscaler" >> $@
	@./createScalerTable.sh "DW  Row" 0 70 33000 1 >>$@

$(ZX7) :
	@$(MAKE) --no-print-directory -C zx7 all

-include Makefile.tmp

Makefile.tmp: Makefile
	@touch $@
	@$(MAKE) -s fullclean


fullclean : clean
	@rm -f *.inc
	@$(MAKE) --no-print-directory -C zx7 clean

clean :
	@rm -rf *.tap *.bin *.lst
	@rm -f *~ */*~

